{% extends "layout.html" %}

{% block title %}Offline - Expense Tracker{% endblock %}

{% block content %}
<div class="container text-center">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card mt-5">
                <div class="card-body py-5">
                    <i class="fas fa-wifi-slash fa-4x text-muted mb-4"></i>
                    <h2 class="h4 mb-3">You're Offline</h2>
                    <p class="text-muted mb-4">
                        No internet connection detected. Don't worry, you can still view your cached data and the app will sync when you're back online.
                    </p>
                    
                    <div class="d-grid gap-2">
                        <button onclick="checkConnection()" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-2"></i>Try Again
                        </button>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>View Cached Data
                        </a>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="text-start">
                        <h6 class="mb-3">Available Offline:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>View recent transactions</li>
                            <li><i class="fas fa-check text-success me-2"></i>Check account balances</li>
                            <li><i class="fas fa-check text-success me-2"></i>Browse categories</li>
                            <li><i class="fas fa-check text-success me-2"></i>View budget goals</li>
                        </ul>
                        
                        <h6 class="mb-3 mt-4">Requires Internet:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-times text-danger me-2"></i>Add new transactions</li>
                            <li><i class="fas fa-times text-danger me-2"></i>AI recommendations</li>
                            <li><i class="fas fa-times text-danger me-2"></i>Receipt scanning</li>
                            <li><i class="fas fa-times text-danger me-2"></i>Data synchronization</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function checkConnection() {
    const button = document.querySelector('button');
    const icon = button.querySelector('i');
    
    // Add loading state
    button.disabled = true;
    icon.className = 'fas fa-spinner fa-spin me-2';
    button.querySelector('span') ? button.querySelector('span').textContent = 'Checking...' : null;
    
    // Check connection
    fetch('/api/ping', {
        method: 'GET',
        cache: 'no-cache'
    })
    .then(response => {
        if (response.ok) {
            // Connection restored
            window.location.href = '{{ url_for("main.dashboard") }}';
        } else {
            throw new Error('Still offline');
        }
    })
    .catch(() => {
        // Still offline
        setTimeout(() => {
            button.disabled = false;
            icon.className = 'fas fa-sync-alt me-2';
            
            // Show temporary feedback
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-times me-2"></i>Still Offline';
            button.className = 'btn btn-danger';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.className = 'btn btn-primary';
            }, 2000);
        }, 1000);
    });
}

// Auto-check connection every 30 seconds
setInterval(() => {
    if (navigator.onLine) {
        fetch('/api/ping', {
            method: 'GET',
            cache: 'no-cache'
        })
        .then(response => {
            if (response.ok) {
                // Show connection restored notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
                notification.innerHTML = `
                    <i class="fas fa-wifi me-2"></i>
                    Connection restored! Redirecting...
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.dashboard") }}';
                }, 2000);
            }
        })
        .catch(() => {
            // Still no server connection
        });
    }
}, 30000);

// Listen for online/offline events
window.addEventListener('online', () => {
    checkConnection();
});

window.addEventListener('offline', () => {
    // Show offline notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-wifi-slash me-2"></i>
        You've gone offline
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
});
</script>
{% endblock %}
