% extends "layout.html" %}

{% block title %}Notifications - FinRelate{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                <div>
                    <h2 class="h3 mb-1">
                        <i class="fas fa-bell me-2" style="color: #7fffd4;" aria-hidden="true"></i>Notifications
                    </h2>
                    <p class="text-muted mb-0">Smart alerts and updates</p>
                </div>
                <div class="mt-2 mt-sm-0">
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="row">
        <div class="col-12">
            {% if notifications %}
                {% for notification in notifications %}
                <div class="card mb-3 notification-card {{ 'border-danger' if notification.priority == 'urgent' else 'border-warning' if notification.priority == 'high' else '' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-{{ 'exclamation-triangle text-danger' if notification.priority == 'urgent' else 'exclamation-circle text-warning' if notification.priority == 'high' else 'info-circle text-info' if notification.notification_type == 'recommendation' else 'bullseye text-success' if notification.notification_type == 'goal_achieved' else 'credit-card text-primary' }} me-2"></i>
                                    <h6 class="mb-0">{{ notification.title }}</h6>
                                    {% if not notification.is_read %}
                                    <span class="badge bg-primary ms-2">New</span>
                                    {% endif %}
                                </div>
                                
                                <p class="mb-2 text-muted">{{ notification.message }}</p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ notification.created_at.strftime('%m/%d/%Y %H:%M') }}
                                    </small>
                                    
                                    <div class="notification-badges">
                                        <span class="badge bg-{{ 'danger' if notification.priority == 'urgent' else 'warning' if notification.priority == 'high' else 'info' if notification.priority == 'normal' else 'secondary' }}">
                                            {{ notification.priority.title() }} Priority
                                        </span>
                                        
                                        <span class="badge bg-{{ 'success' if notification.notification_type == 'goal_achieved' else 'primary' if notification.notification_type == 'budget_alert' else 'info' if notification.notification_type == 'recommendation' else 'secondary' }}">
                                            {{ notification.notification_type.replace('_', ' ').title() }}
                                        </span>
                                    </div>
                                </div>
                                
                                {% if notification.action_url and notification.action_text %}
                                <div class="mt-3">
                                    <a href="{{ notification.action_url }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        {{ notification.action_text }}
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="notification-actions ms-3">
                                <button class="btn btn-sm btn-outline-secondary" onclick="dismissNotification({{ notification.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination could go here if needed -->
                
            {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-bell-slash fa-3x mb-3" style="color: #7fffd4;"></i>
                        <h5>No Notifications</h5>
                        <p class="text-muted">You're all caught up! New notifications will appear here.</p>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-tachometer-alt me-1"></i>Go to Dashboard
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Notification Settings -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2" style="color: #7fffd4;"></i><span class="notification-title" style="color: #7fffd4;">Notification Settings</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Budget Alerts</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="budget-80" checked>
                                    <label class="form-check-label" for="budget-80">
                                        Alert when 80% of budget is reached
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="budget-100" checked>
                                    <label class="form-check-label" for="budget-100">
                                        Alert when budget is exceeded
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="budget-weekly">
                                    <label class="form-check-label" for="budget-weekly">
                                        Weekly budget summary
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Smart Recommendations</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="ai-insights" checked>
                                    <label class="form-check-label" for="ai-insights">
                                        AI spending insights
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="savings-tips" checked>
                                    <label class="form-check-label" for="savings-tips">
                                        Savings opportunities
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monthly-report">
                                    <label class="form-check-label" for="monthly-report">
                                        Monthly financial report
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Push Notifications</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="push-enabled">
                                    <label class="form-check-label" for="push-enabled">
                                        Enable push notifications
                                    </label>
                                </div>
                                <small class="text-muted">Get real-time alerts on your device</small>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Email Notifications</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="email-enabled" checked>
                                    <label class="form-check-label" for="email-enabled">
                                        Enable email notifications
                                    </label>
                                </div>
                                <small class="text-muted">Get notifications in your inbox</small>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Save Settings
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="testNotification()">
                                <i class="fas fa-bell me-1" style="color: #7fffd4;"></i>Test Notification
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dismiss notification
function dismissNotification(notificationId) {
    const card = event.target.closest('.notification-card');
    
    // Animate out
    card.style.opacity = '0.5';
    card.style.transform = 'translateX(20px)';
    
    // Remove after animation
    setTimeout(() => {
        card.remove();
        
        // Check if no more notifications
        const remainingNotifications = document.querySelectorAll('.notification-card');
        if (remainingNotifications.length === 0) {
            location.reload(); // Reload to show "no notifications" message
        }
    }, 300);
    
    // In a real app, you'd make an AJAX call to mark as dismissed
    console.log('Dismissing notification:', notificationId);
}

// Test notification
function testNotification() {
    if ('Notification' in window) {
        Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
                new Notification('FinRelate', {
                    body: 'This is a test notification from your finance tracker!',
                    icon: '/static/icon-192x192.png',
                    tag: 'test-notification'
                });
            } else {
                alert('Please enable notifications in your browser settings.');
            }
        });
    } else {
        alert('Your browser does not support notifications.');
    }
}

// Request notification permission on page load
document.addEventListener('DOMContentLoaded', function() {
    if ('Notification' in window && Notification.permission === 'default') {
        const pushEnabledCheckbox = document.getElementById('push-enabled');
        pushEnabledCheckbox.addEventListener('change', function() {
            if (this.checked) {
                Notification.requestPermission().then(function(permission) {
                    if (permission !== 'granted') {
                        pushEnabledCheckbox.checked = false;
                        alert('Please enable notifications in your browser settings.');
                    }
                });
            }
        });
    }
});

// Auto-refresh notifications every 2 minutes
setInterval(function() {
    // In a real app, you'd check for new notifications via AJAX
    console.log('Checking for new notifications...');
}, 120000);

// Mark all as read when page is viewed
window.addEventListener('beforeunload', function() {
    // Mark all notifications as read
    console.log('Marking all notifications as read...');
});

// Form submission
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Collect form data
    const formData = new FormData(this);
    
    // In a real app, you'd send this to your backend
    console.log('Saving notification settings...');
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>Settings saved!</strong> Your notification preferences have been updated.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    this.insertBefore(alert, this.firstChild);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        alert.remove();
    }, 3000);
});
</script>
{% endblock %}
