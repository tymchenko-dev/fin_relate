{% extends "layout.html" %}

{% block title %}Statistics - FinRelate{% endblock %}

{% block content %}
<style>
    /* Hide the main navbar and flash messages for dashboard consistency */
    .navbar { display: none !important; }
    .container-fluid .alert { display: none !important; }
    main.container-fluid { padding: 0 !important; margin: 0 !important; }
    body { overflow-x: hidden; }
</style>

<!-- Dashboard Layout with Sidebar -->
<div class="dashboard-layout d-flex">
    <!-- Fixed Sidebar Toggle Button -->
    <button class="fixed-sidebar-toggle" id="fixedSidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Modern Sidebar -->
    <div class="modern-sidebar" id="modernSidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('main.index') }}" class="sidebar-brand" title="Go to Homepage">
                <img src="{{ url_for('static', filename='new-logo.png') }}" alt="FinRelate Logo" class="sidebar-logo">
                <span class="brand-text">FinRelate</span>
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.dashboard') }}">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('main.stats') }}">
                        <i class="fas fa-chart-bar"></i>
                        <span>Statistics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.analytics') }}">
                        <i class="fas fa-chart-line"></i>
                        <span>Financial Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="document.getElementById('addTransactionModal').click()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add Transaction</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.settings') }}">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile-sidebar">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <span class="user-name">{{ current_user.username }}</span>
                    <small class="user-status">Online</small>
                </div>
                <div class="user-actions">
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
        <div class="dashboard-container">
            <!-- Modern Header -->
            <div class="modern-dashboard-header">
                <div class="container-fluid">
                    <div class="row align-items-center py-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <!-- Sidebar toggle button -->
                                <button class="sidebar-toggle-btn me-3" id="sidebarToggle">
                                    <i class="fas fa-bars"></i>
                                </button>
                                <div class="welcome-section">
                                    <h1 class="welcome-title" style="color: rgba(255, 255, 255, 0.95);">
                                        <i class="fas fa-chart-line me-2"></i>Statistics
                                    </h1>
                                    <p class="welcome-subtitle mb-0" style="color: rgba(255, 255, 255, 0.8);">Analysis of your income and expenses</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-md-end mt-3 mt-md-0">
                                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-light btn-sm" style="position: absolute; top: 15px; right: 20px; z-index: 1000;">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<style>
    /* Dashboard Layout Styles */
    .dashboard-layout {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--finrelate-light) 0%, #ffffff 100%);
    }
    
    .main-content {
        margin-left: 280px; /* Space for sidebar */
        flex: 1;
        padding: 0;
    }
    
    @media (max-width: 768px) {
        .main-content {
            margin-left: 0;
        }
    }

    /* CSS Variables for FinRelate Theme */
    :root {
        --finrelate-primary: #7AC3AA;
        --finrelate-secondary: #68B39A;
        --deep-blue: #2C5282;
        --calm-green: #81C784;
        --finrelate-light: #F8FFFE;
        --text-dark: #2D3748;
        --text-light: #718096;
    }

    /* Page Background */
    body {
        background: linear-gradient(135deg, var(--finrelate-light) 0%, #ffffff 100%);
    }

    /* Card Styles */
    .card {
        background: white;
        border: none;
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(122, 195, 170, 0.1);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        background: linear-gradient(135deg, var(--deep-blue) 0%, var(--finrelate-primary) 100%);
        color: white;
        border: none;
        border-radius: 20px 20px 0 0 !important;
        padding: 1.5rem;
        font-weight: 600;
    }

    .card-header h5 {
        margin: 0;
        color: white;
    }

    .card-body {
        padding: 2rem;
    }

    /* Button Styles */
    .btn-outline-primary {
        color: var(--deep-blue);
        border-color: var(--finrelate-primary);
        font-weight: 600;
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
        background: linear-gradient(135deg, var(--deep-blue) 0%, var(--finrelate-primary) 100%);
        border-color: var(--finrelate-primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(122, 195, 170, 0.4);
    }

    /* Header Styles */
    .h3 {
        color: var(--text-dark);
        font-weight: 700;
    }

    .text-muted {
        color: var(--text-light) !important;
    }

    /* Table Styles */
    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: linear-gradient(135deg, var(--deep-blue) 0%, var(--finrelate-primary) 100%);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem;
    }

    .table tbody td {
        padding: 1rem;
        border-color: rgba(122, 195, 170, 0.1);
        color: var(--text-dark);
    }

    .table tbody tr:hover {
        background-color: rgba(122, 195, 170, 0.05);
    }

    /* Progress Bars */
    .progress {
        background-color: rgba(122, 195, 170, 0.1);
        border-radius: 10px;
    }

    /* Badge Styles */
    .badge {
        border-radius: 8px;
        font-weight: 500;
    }

    /* Empty State Styles */
    .text-center.text-muted .fas {
        color: var(--finrelate-primary);
    }
    
    /* Category Card Styles */
    .category-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(122, 195, 170, 0.15);
        border-color: var(--finrelate-primary) !important;
    }
    
    .category-icon {
        transition: all 0.3s ease;
    }
    
    .category-card:hover .category-icon {
        transform: scale(1.2);
    }
    
    /* Improved Table Styles */
    .category-row:hover {
        background: linear-gradient(135deg, rgba(122, 195, 170, 0.05) 0%, rgba(255, 255, 255, 0.8) 100%);
        transform: scale(1.01);
        box-shadow: 0 2px 15px rgba(122, 195, 170, 0.1);
    }
    
    .category-dot {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Chart Container Styles */
    .chart-container {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 1rem;
    }
</style>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Content -->
            <div class="container-fluid px-4" style="margin-top: 50px;">
                <div class="row g-4">
    <!-- Expense chart by categories -->
    <div class="col-12 col-xl-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2" aria-hidden="true"></i>Expenses by Categories
                </h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <div class="chart-container w-100" style="position: relative; height: 300px;">
                    <canvas id="categoryChart" 
                            role="img" 
                            aria-label="Pie chart showing expense distribution by categories"
                            width="400" 
                            height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Income/expense chart by months -->
    <div class="col-12 col-xl-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2" aria-hidden="true"></i>Monthly Trends
                </h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <div class="chart-container w-100" style="position: relative; height: 300px;">
                    <canvas id="monthlyChart" 
                            role="img" 
                            aria-label="Line chart showing monthly income, expenses and balance trends"
                            width="400" 
                            height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics table by categories -->
{% if category_stats %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2" aria-hidden="true"></i>Category Breakdown
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="border-0 ps-4">Category</th>
                                <th scope="col" class="border-0">Amount</th>
                                <th scope="col" class="border-0">Percentage</th>
                                <th scope="col" class="border-0 pe-4">Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="category-row" style="transition: all 0.3s ease;">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="category-dot me-3" style="width: 16px; height: 16px; border-radius: 50%; background-color: #FF6384; flex-shrink: 0;"></div>
                                        <span class="fw-semibold text-dark">Food & Dining</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold" style="color: #e74c3c;">$450.50</span>
                                </td>
                                <td>
                                    <span class="fw-medium text-muted">33.5%</span>
                                </td>
                                <td class="pe-4">
                                    <div class="progress" style="height: 8px; background-color: rgba(122,195,170,0.1); border-radius: 10px; min-width: 100px;">
                                        <div class="progress-bar rounded" 
                                             style="width: 33.5%; background: linear-gradient(90deg, #FF6384 0%, #FF6384dd 100%); transition: width 0.6s ease;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="category-row" style="transition: all 0.3s ease;">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="category-dot me-3" style="width: 16px; height: 16px; border-radius: 50%; background-color: #36A2EB; flex-shrink: 0;"></div>
                                        <span class="fw-semibold text-dark">Shopping</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold" style="color: #e74c3c;">$320.75</span>
                                </td>
                                <td>
                                    <span class="fw-medium text-muted">23.8%</span>
                                </td>
                                <td class="pe-4">
                                    <div class="progress" style="height: 8px; background-color: rgba(122,195,170,0.1); border-radius: 10px; min-width: 100px;">
                                        <div class="progress-bar rounded" 
                                             style="width: 23.8%; background: linear-gradient(90deg, #36A2EB 0%, #36A2EBdd 100%); transition: width 0.6s ease;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="category-row" style="transition: all 0.3s ease;">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="category-dot me-3" style="width: 16px; height: 16px; border-radius: 50%; background-color: #4BC0C0; flex-shrink: 0;"></div>
                                        <span class="fw-semibold text-dark">Bills & Utilities</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold" style="color: #e74c3c;">$250.00</span>
                                </td>
                                <td>
                                    <span class="fw-medium text-muted">18.6%</span>
                                </td>
                                <td class="pe-4">
                                    <div class="progress" style="height: 8px; background-color: rgba(122,195,170,0.1); border-radius: 10px; min-width: 100px;">
                                        <div class="progress-bar rounded" 
                                             style="width: 18.6%; background: linear-gradient(90deg, #4BC0C0 0%, #4BC0C0dd 100%); transition: width 0.6s ease;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="category-row" style="transition: all 0.3s ease;">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="category-dot me-3" style="width: 16px; height: 16px; border-radius: 50%; background-color: #FFCE56; flex-shrink: 0;"></div>
                                        <span class="fw-semibold text-dark">Transportation</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold" style="color: #e74c3c;">$180.25</span>
                                </td>
                                <td>
                                    <span class="fw-medium text-muted">13.4%</span>
                                </td>
                                <td class="pe-4">
                                    <div class="progress" style="height: 8px; background-color: rgba(122,195,170,0.1); border-radius: 10px; min-width: 100px;">
                                        <div class="progress-bar rounded" 
                                             style="width: 13.4%; background: linear-gradient(90deg, #FFCE56 0%, #FFCE56dd 100%); transition: width 0.6s ease;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="category-row" style="transition: all 0.3s ease;">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="category-dot me-3" style="width: 16px; height: 16px; border-radius: 50%; background-color: #9966FF; flex-shrink: 0;"></div>
                                        <span class="fw-semibold text-dark">Entertainment</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold" style="color: #e74c3c;">$150.30</span>
                                </td>
                                <td>
                                    <span class="fw-medium text-muted">11.2%</span>
                                </td>
                                <td class="pe-4">
                                    <div class="progress" style="height: 8px; background-color: rgba(122,195,170,0.1); border-radius: 10px; min-width: 100px;">
                                        <div class="progress-bar rounded" 
                                             style="width: 11.2%; background: linear-gradient(90deg, #9966FF 0%, #9966FFdd 100%); transition: width 0.6s ease;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

            </div> <!-- End container-fluid -->
        </div> <!-- End dashboard-container -->
    </div> <!-- End main-content -->
</div> <!-- End dashboard-layout -->

{% endblock %}

{% block scripts %}
<script>
// Category expense chart (pie chart) with demo data
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryChart = new Chart(categoryCtx, {
    type: 'pie',
    data: {
        labels: ['Food & Dining', 'Shopping', 'Transportation', 'Bills & Utilities', 'Entertainment'],
        datasets: [{
            data: [450.50, 320.75, 180.25, 250.00, 150.30],
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
            borderWidth: 3,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': $' + context.parsed.toFixed(2);
                    }
                }
            }
        }
    }
});

// Monthly trends chart (line chart) with demo data
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Income',
            data: [3200, 3400, 3100, 3600, 3800, 3500],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Expenses',
            data: [2800, 2900, 2650, 3100, 3200, 2950],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Balance',
            data: [400, 500, 450, 500, 600, 550],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0);
                    }
                },
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                    }
                }
            }
        }
    }
});
</script>

<!-- Sidebar functionality script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Stats page: DOM loaded, initializing sidebar...');
    
    // Mobile sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    const fixedSidebarToggle = document.getElementById('fixedSidebarToggle');
    const sidebar = document.querySelector('.modern-sidebar');
    const mainContent = document.querySelector('.main-content');
    const overlay = document.createElement('div');
    
    console.log('Elements found:', {
        sidebarToggle: !!sidebarToggle,
        fixedSidebarToggle: !!fixedSidebarToggle,
        sidebar: !!sidebar,
        mainContent: !!mainContent
    });
    
    if ((sidebarToggle || fixedSidebarToggle) && sidebar && mainContent) {
        console.log('All elements found, setting up toggle functionality...');
        
        // Create overlay for mobile
        overlay.className = 'sidebar-overlay d-md-none';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        `;
        document.body.appendChild(overlay);
        
        // Toggle sidebar function
        function toggleSidebar() {
            console.log('toggleSidebar called!');
            const isCollapsed = sidebar.classList.contains('collapsed');
            console.log('Current state - isCollapsed:', isCollapsed);
            
            if (isCollapsed) {
                // Show sidebar
                console.log('Showing sidebar...');
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                document.body.classList.remove('sidebar-collapsed');
                document.body.classList.add('sidebar-open');
                
                // Change icon to bars for both buttons
                if (sidebarToggle) {
                    const icon = sidebarToggle.querySelector('i');
                    icon.className = 'fas fa-bars';
                }
                if (fixedSidebarToggle) {
                    const fixedIcon = fixedSidebarToggle.querySelector('i');
                    fixedIcon.className = 'fas fa-times';
                }
            } else {
                // Hide sidebar
                console.log('Hiding sidebar...');
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                document.body.classList.add('sidebar-collapsed');
                document.body.classList.remove('sidebar-open');
                
                // Change icon to arrow right for original, bars for fixed
                if (sidebarToggle) {
                    const icon = sidebarToggle.querySelector('i');
                    icon.className = 'fas fa-arrow-right';
                }
                if (fixedSidebarToggle) {
                    const fixedIcon = fixedSidebarToggle.querySelector('i');
                    fixedIcon.className = 'fas fa-bars';
                }
            }
            
            console.log('After toggle - sidebar classes:', sidebar.className);
            console.log('After toggle - mainContent classes:', mainContent.className);
            
            // Mobile overlay logic
            if (window.innerWidth < 768) {
                overlay.style.display = isCollapsed ? 'none' : 'block';
            }
        }
        
        // Add event listeners to both buttons
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function(e) {
                console.log('sidebarToggle clicked!');
                e.preventDefault();
                toggleSidebar();
            });
            console.log('sidebarToggle event listener attached');
        }
        if (fixedSidebarToggle) {
            fixedSidebarToggle.addEventListener('click', function(e) {
                console.log('fixedSidebarToggle clicked!');
                e.preventDefault();
                toggleSidebar();
            });
            console.log('fixedSidebarToggle event listener attached');
        }
        
        // Mobile overlay click handler
        overlay.addEventListener('click', function() {
            if (window.innerWidth < 768) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                overlay.style.display = 'none';
                
                if (sidebarToggle) {
                    const icon = sidebarToggle.querySelector('i');
                    icon.className = 'fas fa-arrow-right';
                }
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) {
                overlay.style.display = 'none';
            }
        });
    } else {
        console.log('ERROR: Not all required elements found!');
        console.log('Missing elements:', {
            sidebarToggle: !sidebarToggle ? 'MISSING' : 'found',
            fixedSidebarToggle: !fixedSidebarToggle ? 'MISSING' : 'found',
            sidebar: !sidebar ? 'MISSING' : 'found',
            mainContent: !mainContent ? 'MISSING' : 'found'
        });
    }
});
</script>

{% endblock %}
